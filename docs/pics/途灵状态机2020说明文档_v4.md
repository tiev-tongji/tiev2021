# 途灵状态机2020说明文档

## 高速状态机（暂不实现）

### 高速正常驾驶

* 高速状态下正常行驶状态
## 低速状态机

##### 状态机切换滤波
- john 状态机切换过程中是否设置了一个等待时间？防止频繁切换
  + 先设置一个计时在那，是否使用再讨论


### 出发状态机

#### 一次规划：
车辆起步，从服务器获取全局参考路，成功后进入**回归**

----

### OnRoad状态机

#### 回归：

此时车辆应未在参考道路（参考路对应同向所有车道构成的道路）上，因此需要规划回到参考道路上，回归步骤：

* 目标点选择为从参考路离车辆最近处算起，沿参考路向前s=20米处的位置，并固定
* 看实线回归，此时车辆只能通过虚线处回到道路，**实线自由规划**
* 若实线回归失败，则去除车辆前方十米内的实线规划, **无实线自由规划**
* 若以上还规划失败，则去除所有道路限制，自由规划, **实线自由规划**

* 直到判定车辆回到参考道路且方向正确后，进入正常驾驶
* 如果失败或无定位则进入探索状态 

##### COMMNETS
###### john: 
- 是否有必要增加去除前方十米的实线 
  * 有必要，否则直接去除所有实线，回归路径会变得很平缓，达不到快速回归的目的

#### 正常驾驶：

此时车辆应在参考道路上，规划步骤：

* 若局部地图中出现上下客点（任务点），则进入**临时停靠状态机**
* 若参考路径给出当前为路口，则进入**路口状态机**
* 每条车道最远处选择一个目标点（速度慢，一个足以）
* 抠除动态车辆和行人做路径规划和速度规划
* 不扣除动态车辆做路径规划和速度规划
* 选择在规划时间内（5s处），沿参考路径路径方向（投影到参考路径）走的距离最长的为最优路径（其他属性也许加权进来，需测试得到最合适的结果）
* 正常驾驶考虑所有实线为不可逾越障碍
* 正常驾驶不进行向后规划
* 若以上规划失败或无定位，则进入**实线自由规划**

##### COMMNETS
###### john: 
- 最优路径为总时间最短？
  + 5s内沿参考路径方向尽量远，且尽量平滑和安全，需要调权重
  - 不如时间好计算吧？
  - 单纯看时间没有意义，路径短的时间基本就很短，不一定就比路径长的更好，要想实现超车，规划时间内能往前走更远的才合理，而不是单独看规划路径的长短和时间。

#### 实线自由规划

相对于正常驾驶，多出倒车规划

* 选择路径最安全的为最优路径（由于有倒车路径，且速度规划只会规划第一段路径，因此最优路径选择需要改变）
  + 目前的想法是择优函数包含离障碍物最近距离，路径的平均曲率等，具体还需讨论
* 若规划出的路径无倒车路径，则回到**正常驾驶**
* 若规划失败或无定位，则进入**无实线自由**

#### 无实线自由

不受实线约束，该状态下车辆规划的路径应会出参考道路，规划与路径选择同实线自由规划

* 若车辆行驶到参考道路意外，则进入**回归**
* 若规划失败，则证明已经无路可走，进入**一次重规划**


#### 一次重规划

* 区别于一次规划，该一次重规划将告诉服务器当前参考路径段无法通行，应重新规划出路径
*  服务器在路况更新后，应将该路段临时障碍去除
* 若一次重规划成功，则进入**回归**

#### 探索

回归失败，证明哪怕给出了参考路，给出了目标点，但是依然没办法回到道路上，那应该是进入了特殊路段，比如用水马给你引导到人行道上通过

* 若当前无定位，则沿着车道线保持，否则执行以下步骤

* 目标点选取在车前十米可到达范围内，且应尽量靠近参考路径，无方向约束
* 不受任何车道线约束，自由规划
* 尝试向参考路径最远处为目标点规划，若成功则返回**回归**
* 限制车速为5kph
* 探索超时之后进入一次重规划
* 3次探索超时后**驻停**
  + 何必三次？一旦卡在一个地方，无数次都和第一次一样。

---

### 路口状态机

#### 安全驾驶

此时车辆应在路口前实线区，一般不允许换道，需要看红绿灯和礼让行人

* 抠除动态车辆和行人进行路径规划和速度规划
* 若此时为红灯，则在停止线处设置速度为0的虚拟动态障碍物
* 若车辆相邻车道范围内有行人，则在车前设置速度为0的虚拟障碍物，让行（此处需要考虑行人是在车道上还是在路边，车辆在路边车道时，道路外的行人 应不予考虑）
* 若车辆在该状态下持续停车超过60s（速度<0.5m/s，防止突然动一下刷新计时），则认为该路口在交通引导，进入**无实线自由**

##### COMMNETS
###### john: 
- 路口中参考路虚拟边界保留，无需特殊处理？ 
  + 正常保留，无处理
  - 是否会出现路口内避障？由于虚拟边界导致无法避障？
  - 超时后会进入**无实线自由**，不会因实线导致无法避障
- 正常结束后需返回到**OnRoad状态机::正常驾驶**
  + 地图决定回到OnRoad状态机
  - 状态机图中需要绘制双向箭头
- 超时后是否直接返回到**OnRoad状态机::无实线自由**?
  + 不可，OnRoad状态机里的无实线自由最后会返回OnRoad的正常驾驶，这里最后需先返回**安全驾驶**，因为车辆返回回来可能还是在路口
  - 如果返回**OnRoad状态机**，那么根据地图也会转移到**路口状态机**对吗？另外，路口状态机中状态之间的转换不完整
  - 如果车辆处在路口实线区内，是会回来的。为何转换不完整？

#### 无实线自由

同OnRoad无实线自由

#### 回归

同OnRoad回归

---

### 临时停靠状态机

#### 临停规划

路边发现了上下客点（任务点），需要稳定停入路边库位
* 取消实线
* 选取上下客点所有库位点为目标点
* 先使用五次曲线直接生成路径（该路径更平稳，速度也快，若是坚持只使用A*可去掉该步），若规划失败，则使用A\*规划
* 若成功停靠，则进入**临停**

##### COMMNETS
###### john: 
- 是否可以使用rs曲线？ 
  + RS曲线不能保证曲率平滑，对于需要精准停靠这个任务比较难，而且途灵A*搜出来的路不就是RS曲线吗？
  + 先解决控制


#### 临停

需要停止10-15s

* 停车计时10s
* 计时结束后，若该停靠点为上客点，则直接进入**一次规划**去下客点；若该点为下客点，则进入**接客决策**

#### 接客决策

* 计算到达下一个上客点的一次规划路径长度，有上客点到达下客点的一次规划长度，由下客点返回停车场的长度
* 估算以上路径长度需花费时长，若<比赛剩余时长，则选择下一上客点做一次规划，若>剩余比赛时长，则选择停车场做一次规划

#### 一次规划

完成后进入**回归**

---

### 泊车状态机

#### 寻库

* 沿参考路径行驶，同时检测是否出现空库位
* 若检测到空库位，则进入**入库**

#### 入库

* 将检测到的空库位作为目标点，同时固定

* 倒车规划
* 若成功入库，则进入**驻停**

#### 驻停

车辆停止，不能启动，发送速度为0的路径即可

##### COMMNETS
###### john: 
- 寻库未果，应进入**探索**状态
  + 不应进入探索状态，若当前参考路走完还寻到库位，则更换参考路，可以将刚那条直接反向，也可以是一条新的参考路
  - john：如何更换参考路？应该进入**探索寻库**状态, 类似于探索过程中不停寻库
  - 更换参考路由服务器提供或预设好，比赛场地的地下车库为“F”型，车辆探索寻库不可能倒车，会卡在一个尽头。
---

### 雨雾调控

上层雨雾调控，若当前检测到雨雾，则关闭激光感知，只开启ESR和历史地图，否则什么也不做

---

### 遥控急停调控

若遥控急停车辆，则保存当前各状态，禁止跳转，解除时，重新进入保存的状态，主要是为了存在计时设置的状态

---

### 参考路调控

每隔一段时间（10s）向服务器发起一次参考路查询，若车辆当前状态适合更换该新参考路，则更换，否则不予更换

##### COMMNETS
###### john: 
- 比较参考路通过何种方式更好？ 
  + 若新参考路的在当前车辆位置与旧参考路是同向的，则可以直接切换，若是反向的则先沿旧参考路继续行驶至前方可掉头处再切换
  - 一般不应该出现反向的参考路，除非道路封闭